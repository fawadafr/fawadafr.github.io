{% assign maxRelated = site.related_posts_count | default: 3 %}

<!-- Use Jekyll's built-in related_posts with LSI when enabled -->
{% if site.lsi %}
  <!-- LSI-powered semantic similarity (smarter recommendations) -->
  {% assign relatedPosts = site.related_posts | where_exp: "post", "post.url != page.url" %}
{% else %}
  <!-- Fallback to tag-based matching -->
  {% assign minCommonTags = 1 %}
  {% assign maxRelatedCounter = 0 %}
  {% assign relatedPosts = '' | split: '' %}

  {% for post in site.posts %}
    {% if post.url != page.url %}
      {% assign sameTagCount = 0 %}
      {% for tag in post.tags %}
        {% if page.tags contains tag %}
          {% assign sameTagCount = sameTagCount | plus: 1 %}
        {% endif %}
      {% endfor %}

      {% if sameTagCount >= minCommonTags %}
        {% assign relatedPosts = relatedPosts | push: post %}
        {% assign maxRelatedCounter = maxRelatedCounter | plus: 1 %}
        {% if maxRelatedCounter >= maxRelated %}
          {% break %}
        {% endif %}
      {% endif %}
    {% endif %}
  {% endfor %}

  <!-- Fallback to recent posts if not enough related posts -->
  {% if relatedPosts.size < maxRelated %}
    {% for post in site.posts %}
      {% if post.url != page.url %}
        {% unless relatedPosts contains post %}
          {% assign relatedPosts = relatedPosts | push: post %}
          {% if relatedPosts.size >= maxRelated %}
            {% break %}
          {% endif %}
        {% endunless %}
      {% endif %}
    {% endfor %}
  {% endif %}
{% endif %}

{% if relatedPosts.size > 0 %}
<section class="related-posts">
  <h3>Related Articles</h3>
  <div class="related-grid">
    {% for post in relatedPosts limit: maxRelated %}
    <article class="related-post">
      <h4><a href="{{ post.url | relative_url }}" data-event="related-post-click" data-post-title="{{ post.title | escape }}">{{ post.title }}</a></h4>
      {% if post.excerpt %}
        <p class="excerpt">{{ post.excerpt | strip_html | truncate: 120 }}</p>
      {% endif %}
      {% if post.tags %}
        <div class="post-tags">
          {% for tag in post.tags limit: 3 %}
            <span class="tag">{{ tag }}</span>
          {% endfor %}
        </div>
      {% endif %}
    </article>
    {% endfor %}
  </div>
</section>
{% endif %}
