<!-- PWA Manifest -->
<link rel="manifest" href="/manifest.json">

<!-- PWA Theme Color -->
<meta name="theme-color" content="#2563EB" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#60A5FA" media="(prefers-color-scheme: dark)">

<!-- Apple Touch Icons -->
<link rel="apple-touch-icon" sizes="152x152" href="/assets/icons/icon-152x152.png">
<link rel="apple-touch-icon" sizes="192x192" href="/assets/icons/icon-192x192.png">

<!-- Apple Mobile Web App -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Fawad Rashidi">

<!-- PWA Service Worker Registration & Install Prompt -->
<script>
// Service Worker Registration
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker
      .register('/sw.js')
      .then((registration) => {
        console.log('[PWA] Service Worker registered:', registration.scope);

        // Check for updates periodically
        setInterval(() => {
          registration.update();
        }, 60 * 60 * 1000); // Check every hour
      })
      .catch((error) => {
        console.error('[PWA] Service Worker registration failed:', error);
      });
  });
}

// PWA Install Prompt
let deferredPrompt;
const installButton = document.getElementById('pwa-install-button');

window.addEventListener('beforeinstallprompt', (e) => {
  // Prevent the mini-infobar from appearing on mobile
  e.preventDefault();

  // Stash the event so it can be triggered later
  deferredPrompt = e;

  // Show install button
  if (installButton) {
    installButton.style.display = 'block';
  }

  console.log('[PWA] Install prompt available');
});

// Handle install button click
if (installButton) {
  installButton.addEventListener('click', async () => {
    if (!deferredPrompt) {
      return;
    }

    // Show the install prompt
    deferredPrompt.prompt();

    // Wait for the user's response
    const { outcome } = await deferredPrompt.userChoice;
    console.log(`[PWA] User response to install prompt: ${outcome}`);

    // Clear the deferred prompt
    deferredPrompt = null;

    // Hide the install button
    installButton.style.display = 'none';
  });
}

// Track successful installation
window.addEventListener('appinstalled', () => {
  console.log('[PWA] App installed successfully');
  deferredPrompt = null;

  // Track with analytics if available
  if (typeof gtag !== 'undefined') {
    gtag('event', 'pwa_install', {
      'event_category': 'engagement',
      'event_label': 'pwa_installed'
    });
  }
});

// Display mode detection (for analytics)
window.addEventListener('DOMContentLoaded', () => {
  const isPWA = window.matchMedia('(display-mode: standalone)').matches ||
                window.navigator.standalone ||
                document.referrer.includes('android-app://');

  if (isPWA) {
    console.log('[PWA] Running as installed app');
    document.body.classList.add('pwa-mode');

    // Track PWA usage
    if (typeof gtag !== 'undefined') {
      gtag('event', 'pwa_launch', {
        'event_category': 'engagement',
        'event_label': 'pwa_opened'
      });
    }
  }
});
</script>

<!-- PWA Install Button (optional, styled inline) -->
<style>
#pwa-install-button {
  display: none;
  position: fixed;
  bottom: 20px;
  right: 20px;
  padding: 12px 24px;
  background: var(--color-accent);
  color: #FFFFFF;
  border: none;
  border-radius: 8px;
  font-family: var(--font-primary);
  font-size: var(--text-para-s);
  font-weight: var(--font-medium);
  cursor: pointer;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  z-index: 1000;
  transition: transform 0.2s, box-shadow 0.2s;
}

#pwa-install-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
}

#pwa-install-button:active {
  transform: translateY(0);
}

/* Hide in PWA mode */
.pwa-mode #pwa-install-button {
  display: none !important;
}

/* Mobile optimizations */
@media (max-width: 768px) {
  #pwa-install-button {
    bottom: 16px;
    right: 16px;
    left: 16px;
    text-align: center;
  }
}
</style>

<button id="pwa-install-button" aria-label="Install app">
  <span>ðŸ“± Install App</span>
</button>
